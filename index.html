<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ORCHARD POCKET (MK VII)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap');
        
        :root {
            --bg-void: #1a1919;
            --chassis: #e6e2d8;
            --panel: #d6d0c4;
            --bone: #333;
            --screen-bg: #222;
            --screen-lit: #ff9e40;
            --accent: #e67e22;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-void);
            height: 100vh;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Space Mono', monospace;
            overflow: hidden;
            color: var(--bone);
        }

        #device {
            width: 950px; height: 680px;
            background-color: var(--chassis);
            border-radius: 16px;
            box-shadow: 
                inset 0 0 40px rgba(255,255,255,0.5),
                inset 0 0 10px rgba(0,0,0,0.1),
                0 30px 80px #000;
            border-bottom: 8px solid #bbb;
            padding: 25px;
            display: grid;
            grid-template-rows: 140px 1fr 110px;
            gap: 20px;
            position: relative;
            max-width: 98vw; max-height: 98vh;
        }

        /* SCREEN */
        .top-section { display: flex; gap: 20px; height: 100%; }
        .screen-bezel { flex: 2; background: #111; border-radius: 8px; padding: 4px; box-shadow: inset 0 2px 10px #000; }
        #main-canvas { width: 100%; height: 100%; background: var(--screen-bg); border-radius: 4px; filter: blur(0.5px) contrast(1.2) sepia(0.2); }
        .data-panel { flex: 1; background: var(--panel); border: 1px solid #bbb; border-radius: 6px; padding: 15px; display: flex; flex-direction: column; justify-content: space-between; }
        .readout { font-size: 0.8rem; color: #666; font-weight: bold; }
        .val-big { font-size: 1.6rem; color: var(--bone); }
        
        /* MID SECTION */
        .mid-section { display: grid; grid-template-columns: 200px 1fr 220px; gap: 20px; }
        
        /* JOYSTICK */
        .joy-panel {
            background: #d0c8bb; border-radius: 50%; width: 180px; height: 180px;
            border: 1px solid #bbb; box-shadow: inset 0 5px 15px rgba(0,0,0,0.1), 5px 10px 20px rgba(0,0,0,0.1);
            position: relative; align-self: center; justify-self: center;
        }
        .joy-label { position: absolute; font-size: 0.7rem; color: #888; font-weight: bold; pointer-events: none; }
        .jl-n { top: 15px; left: 50%; transform: translateX(-50%); } 
        .jl-s { bottom: 15px; left: 50%; transform: translateX(-50%); } 
        .jl-e { right: 10px; top: 50%; transform: translateY(-50%); } 
        .jl-w { left: 10px; top: 50%; transform: translateY(-50%); } 
        #joy-stick {
            width: 60px; height: 60px; background: radial-gradient(circle at 30% 30%, #555, #222);
            border-radius: 50%; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            border: 2px solid #666;
        }

        /* PADS */
        .chord-grid { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(2, 1fr); gap: 10px; }
        .chord-btn {
            background: linear-gradient(135deg, #f0ede5, #dcd8cc);
            border: 1px solid #bbb; border-bottom: 4px solid #aaa; border-radius: 6px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; position: relative;
        }
        .chord-btn:active, .chord-btn.active { transform: translateY(3px); border-bottom: 1px solid #aaa; background: #fff; box-shadow: 0 0 15px var(--accent); }
        .roman { font-size: 1.6rem; font-weight: bold; color: #444; }
        .chord-name { font-size: 0.7rem; color: #888; }

        /* SETTINGS */
        .settings-panel {
            background: #dcd6cb; border: 1px solid #bbb; border-radius: 6px; padding: 15px;
            display: flex; flex-direction: column; gap: 8px; overflow-y: auto;
        }
        .knob-row { display: flex; flex-direction: column; gap: 2px; }
        input[type=range] { width: 100%; accent-color: var(--accent); cursor: pointer; height: 5px; }
        .cart-select { display: flex; gap: 2px; margin-top: 5px; }
        .cart-btn { flex: 1; padding: 6px 0; border: 1px solid #aaa; background: #e6e2d8; font-family: 'Space Mono'; font-size: 0.7rem; cursor: pointer; }
        .cart-btn.active { background: var(--bone); color: #fff; }
        
        select { background: #e6e2d8; border: 1px solid #aaa; font-family: 'Space Mono'; padding: 5px; width: 100%; font-size: 0.8rem; }
        
        /* BOT SECTION */
        .bot-section {
            background: #d0c8bb; border-top: 1px solid #bbb; border-radius: 0 0 8px 8px;
            display: flex; align-items: center; justify-content: space-between; padding: 0 25px;
        }
        .t-btn { 
            width: 45px; height: 45px; border-radius: 50%; border: 1px solid #999;
            background: #e6e2d8; display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 1.2rem; color: #555;
        }
        .t-btn:active { transform: translateY(2px); }

        #overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(26, 25, 25, 0.95); z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: var(--chassis);
        }
        .start-btn { border: 2px solid var(--accent); color: var(--accent); background: transparent; padding: 15px 40px; font-family: 'Space Mono'; font-size: 1.5rem; border-radius: 30px; cursor: pointer; margin-top: 20px;}

        @media (max-width: 800px) {
            #device { width: 100vw; height: 100vh; border: none; border-radius: 0; padding: 10px; grid-template-rows: 100px 1fr 70px; }
            .mid-section { grid-template-columns: 1fr; grid-template-rows: auto 1fr auto; gap: 10px; }
            .joy-panel { width: 120px; height: 120px; order: 2; margin: 0 auto; }
            .chord-grid { order: 1; height: 200px; }
            .settings-panel { order: 3; }
        }
    </style>
</head>
<body>

<div id="overlay">
    <div style="font-size:2.5rem; font-weight:bold;">ORCHARD MK VII</div>
    <div style="color:#888;">PERFORMANCE EDITION</div>
    <button class="start-btn" id="btn-init">POWER ON</button>
</div>

<div id="device">
    <div class="top-section">
        <div class="screen-bezel"><canvas id="main-canvas" width="600" height="150"></canvas></div>
        <div class="data-panel">
            <div><div class="readout">CHORD</div><div class="val-big" id="disp-chord">--</div></div>
            <div><div class="readout">MODE</div><div class="val-big" id="disp-mode">STRUM</div></div>
            <div><div class="readout">BPM</div><div class="val-big" id="disp-bpm">100</div></div>
        </div>
    </div>

    <div class="mid-section">
        <div class="joy-panel" id="joy-base">
            <span class="joy-label jl-n">MINOR</span>
            <span class="joy-label jl-s">DOM 7</span>
            <span class="joy-label jl-w">SUS 4</span>
            <span class="joy-label jl-e">MAJ 7</span>
            <div id="joy-stick"></div>
        </div>

        <div class="chord-grid">
            <div class="chord-btn" id="btn-0" onmousedown="triggerUI(0)" ontouchstart="triggerUI(0)"><span class="roman">I</span></div>
            <div class="chord-btn" id="btn-1" onmousedown="triggerUI(1)" ontouchstart="triggerUI(1)"><span class="roman">ii</span></div>
            <div class="chord-btn" id="btn-2" onmousedown="triggerUI(2)" ontouchstart="triggerUI(2)"><span class="roman">iii</span></div>
            <div class="chord-btn" id="btn-3" onmousedown="triggerUI(3)" ontouchstart="triggerUI(3)"><span class="roman">IV</span></div>
            <div class="chord-btn" id="btn-4" onmousedown="triggerUI(4)" ontouchstart="triggerUI(4)"><span class="roman">V</span></div>
            <div class="chord-btn" id="btn-5" onmousedown="triggerUI(5)" ontouchstart="triggerUI(5)"><span class="roman">vi</span></div>
            <div class="chord-btn" id="btn-6" onmousedown="triggerUI(6)" ontouchstart="triggerUI(6)"><span class="roman">vii°</span></div>
            <div class="chord-btn" onclick="killAll()"><span class="roman">■</span></div>
        </div>

        <div class="settings-panel">
            <div class="knob-row">
                <label class="readout">PERFORMANCE MODE</label>
                <select id="mode-select" onchange="setPerfMode(this.value)">
                    <option value="STRUM">STRUM (Guitar)</option>
                    <option value="STRUM2">STRUM 2 OCT</option>
                    <option value="SLOP">SLOP (Human)</option>
                    <option value="ARP">ARPEGGIATOR</option>
                    <option value="ARP2">ARP 2 OCT</option>
                    <option value="PATTERN">PATTERN (Rhythmic)</option>
                    <option value="HARP">HARP (Sweep)</option>
                </select>
            </div>
            
            <div class="knob-row" style="margin-top:5px;">
                <label class="readout">PERFORMANCE DIAL</label>
                <input type="range" min="0" max="100" value="50" oninput="updatePerfDial(this.value)">
                <div style="font-size:0.7rem; color:#888; text-align:right;" id="dial-label">Speed</div>
            </div>

            <div class="knob-row" style="margin-top:5px;">
                <label class="readout">BPM</label>
                <input type="range" min="60" max="180" value="100" oninput="setBPM(this.value)">
            </div>

            <div class="knob-row" style="margin-top:5px;">
                <label class="readout">AGE (WOBBLE)</label>
                <input type="range" min="0" max="100" value="40" oninput="setParam('age', this.value/100)">
            </div>
            
            <div class="cart-select">
                <button class="cart-btn active" id="cart-0" onclick="setCart(0)">REED</button>
                <button class="cart-btn" id="cart-1" onclick="setCart(1)">TINE</button>
                <button class="cart-btn" id="cart-2" onclick="setCart(2)">SYNTH</button>
            </div>
        </div>
    </div>

    <div class="bot-section">
        <div class="octave-ctrl">
            <button class="t-btn" onclick="changeOctave(-1)">-</button>
            <span id="disp-oct" style="font-weight:bold; margin:0 10px;">OCT 0</span>
            <button class="t-btn" onclick="changeOctave(1)">+</button>
        </div>
    </div>
</div>

<script>
/* =========================================
   DSP KERNEL: "ORCHARD ENGINE MK VII"
   ========================================= */
const DSP_CODE = `
class TapePhysics {
    constructor(sr) { this.t = 0; }
    process() {
        this.t += 0.005;
        return 1.0 + (Math.sin(this.t * 0.5) * 0.002) + (Math.sin(this.t * 8.0) * 0.001);
    }
}
class StereoChorus {
    constructor(sr) {
        this.sr = sr; this.len = Math.floor(sr*0.05); this.wIdx=0; this.lfo=0;
        this.bufL = new Float32Array(this.len); this.bufR = new Float32Array(this.len);
    }
    process(L, R, depth) {
        this.lfo += 0.002;
        this.bufL[this.wIdx] = L; this.bufR[this.wIdx] = R;
        const dL = 400 + Math.sin(this.lfo)*200*depth;
        const dR = 400 + Math.sin(this.lfo + 2.0)*200*depth;
        const outL = this.read(this.bufL, dL); const outR = this.read(this.bufR, dR);
        this.wIdx++; if(this.wIdx >= this.len) this.wIdx=0;
        return [outL, outR];
    }
    read(buf, d) {
        let r = this.wIdx - d; if(r<0) r+=this.len;
        const i = Math.floor(r); const f = r-i; const n = (i+1)%this.len;
        return buf[i]*(1-f) + buf[n]*f;
    }
}
class OrchardProc extends AudioWorkletProcessor {
    constructor(opts) {
        super();
        this.sr = opts.processorOptions.sampleRate;
        this.tape = new TapePhysics(this.sr);
        this.chorus = new StereoChorus(this.sr);
        this.tables = [
            this.gen([1, 0.2, 0.6, 0.1, 0.05]), // Reed
            this.gen([1, 0.8, 0.05, 0.0]),      // Tine
            this.gen([1, 0.5, 0.3, 0.25, 0.2])  // Synth
        ];
        this.voices = [];
        for(let i=0; i<24; i++) this.voices.push({active:false, freq:440, phase:0, env:0, state:'off', pan:(Math.random()*2-1)*0.3});
        this.params = { age: 0.4, shape: 0 };
        this.port.onmessage = e => {
            if(e.data.type==='noteOn') this.trig(e.data.freq, e.data.vel || 1.0);
            if(e.data.type==='kill') this.killAll();
            if(e.data.type==='param') this.params[e.data.key] = e.data.val;
        }
    }
    gen(h) {
        const t = new Float32Array(2048);
        for(let i=0; i<2048; i++) { let s=0; h.forEach((v,k)=>s+=Math.sin((i/2048)*6.28*(k+1))*v); t[i]=s; }
        return t;
    }
    trig(freq, vel) {
        let v = this.voices.find(x => !x.active);
        if(!v) v = this.voices[0];
        v.active = true; v.freq = freq; v.env = 0; v.state = 'att'; v.vel = vel;
    }
    killAll() { this.voices.forEach(v => { if(v.active) v.state='rel'; }); }
    process(inps, outs) {
        const out = outs[0]; const age = this.params.age; const table = this.tables[this.params.shape];
        const warp = 1.0 + (this.tape.process()-1.0)*(age*2.0);
        for(let i=0; i<out[0].length; i++) {
            let L=0, R=0;
            for(let v of this.voices) {
                if(!v.active) continue;
                if(v.state==='att') { v.env+=0.05; if(v.env>=v.vel) v.state='dec'; }
                if(v.state==='dec') { v.env-=0.002; if(v.env<=v.vel*0.6) v.state='sus'; }
                if(v.state==='sus') { v.env-=0.0001; if(v.env<=0) v.active=false; }
                if(v.state==='rel') { v.env-=0.05; if(v.env<=0) v.active=false; }
                const step = (v.freq * warp * 2048)/this.sr; v.phase += step; if(v.phase>=2048) v.phase-=2048;
                const idx = Math.floor(v.phase); const nxt = (idx+1)%2048; const fr = v.phase-idx;
                const s = (table[idx]*(1-fr) + table[nxt]*fr) * v.env;
                L += s*(1-v.pan); R += s*(1+v.pan);
            }
            if(age > 0.1) { const w = this.chorus.process(L, R, age); L=L*(1-age*0.5)+w[0]*age*0.5; R=R*(1-age*0.5)+w[1]*age*0.5; }
            out[0][i] = L*0.15; if(out[1]) out[1][i] = R*0.15;
        }
        return true;
    }
}
registerProcessor('orchard-proc', OrchardProc);
`;

/* =========================================
   SYSTEM LOGIC
   ========================================= */
let ctx, worklet;
let joy = {x:0, y:0};
let globalOctave = 0;
let currentBPM = 100;

// THEORY
const MAJOR_SCALE = [0, 2, 4, 5, 7, 9, 11];
const ROOT_NOTE = 48; // C3
let lastCentroid = 60;

// PERFORMANCE ENGINE
let perfMode = 'STRUM';
let perfDial = 0.5; // 0.0 to 1.0
let activeTimer = null; // For loops

async function init() {
    if(ctx) return;
    const AC = window.AudioContext || window.webkitAudioContext;
    ctx = new AC();
    if (ctx.state === 'suspended') await ctx.resume();
    
    const blob = new Blob([DSP_CODE], {type:'application/javascript'});
    const url = URL.createObjectURL(blob);
    try { await ctx.audioWorklet.addModule(url); } catch(e) { alert("Worklet Error"); return; }
    
    worklet = new AudioWorkletNode(ctx, 'orchard-proc', { outputChannelCount: [2] });
    worklet.connect(ctx.destination);
    
    document.getElementById('overlay').style.display = 'none';
    requestAnimationFrame(drawScreen);
}

function getSmartNotes(intervals, root) {
    const raw = intervals.map(i => root + i);
    let candidates = [];
    [-1, 0, 1].forEach(oct => {
        const base = raw.map(n => n + (oct*12));
        candidates.push(base); 
        candidates.push([base[1], base[2], base[0]+12]); 
        candidates.push([base[2], base[0]+12, base[1]+12]); 
    });
    let best = candidates[0], minDist = Infinity;
    candidates.forEach(cand => {
        const avg = cand.reduce((a,b)=>a+b,0)/cand.length;
        const dist = Math.abs(avg - lastCentroid);
        if(dist < minDist) { minDist = dist; best = cand; }
    });
    lastCentroid = best.reduce((a,b)=>a+b,0)/best.length;
    let bass = root - 12; while(bass > 45) bass -= 12;
    return [...best, bass];
}

function mtof(m) { return 440 * Math.pow(2, (m-69)/12); }

/* --- PERFORMANCE MODES --- */
function triggerUI(deg) {
    if(!ctx) { init(); return; }
    if(ctx.state === 'suspended') ctx.resume();
    if(!worklet) return;

    // 1. Get Notes
    const scaleNote = ROOT_NOTE + MAJOR_SCALE[deg] + (globalOctave * 12);
    let intervals = [0, 4, 7]; let quality = "MAJ";
    
    if([1,2,5,6].includes(deg)) { intervals = [0, 3, 7]; quality = "min"; }
    if(deg===6) { intervals = [0, 3, 6]; quality = "dim"; }
    
    if(joy.y < -0.5) { intervals = [0, 3, 7]; quality = "min"; }
    if(joy.y > 0.5) { intervals = [0, 4, 7, 10]; quality = "dom7"; }
    if(joy.x > 0.5) { intervals = [0, 4, 7, 11]; quality = "maj7"; }
    if(joy.x < -0.5) { intervals = [0, 5, 7]; quality = "sus4"; }
    
    let notes = getSmartNotes(intervals, scaleNote);
    
    // 2. Clear previous performance
    if(activeTimer) clearInterval(activeTimer);
    worklet.port.postMessage({type:'kill'}); 

    // 3. EXECUTE PERFORMANCE MODE
    const now = ctx.currentTime;
    
    // Sort notes for Strum/Arp (Low to High)
    notes.sort((a,b) => a-b);
    
    if (perfMode === 'STRUM') {
        // Linear delay
        const speed = 10 + (perfDial * 100); // 10ms to 110ms
        notes.forEach((midi, i) => {
            scheduleNote(midi, now + (i * speed / 1000));
        });
        
    } else if (perfMode === 'STRUM2') {
        // Strum across 2 octaves
        const speed = 10 + (perfDial * 100);
        let extNotes = [...notes, ...notes.map(n => n+12)];
        extNotes.sort((a,b) => a-b);
        extNotes.forEach((midi, i) => {
            scheduleNote(midi, now + (i * speed / 1000));
        });
        
    } else if (perfMode === 'SLOP') {
        // Random timing
        const slopAmt = perfDial * 0.1; // up to 100ms jitter
        notes.forEach(midi => {
            scheduleNote(midi, now + (Math.random() * slopAmt));
        });
        
    } else if (perfMode === 'ARP' || perfMode === 'ARP2') {
        // Looping Arpeggiator
        const msPerBeat = 60000 / currentBPM;
        // Dial selects subdivision: 1/4 (0-0.3), 1/8 (0.3-0.6), 1/16 (0.6-1.0)
        let div = 1;
        if(perfDial > 0.3) div = 0.5; // 8th
        if(perfDial > 0.6) div = 0.25; // 16th
        const stepTime = msPerBeat * div;
        
        let playSet = [...notes];
        if(perfMode === 'ARP2') playSet = [...notes, ...notes.map(n=>n+12)].sort((a,b)=>a-b);
        
        let idx = 0;
        // Immediate first note
        scheduleNote(playSet[0], now);
        idx = (idx + 1) % playSet.length;
        
        activeTimer = setInterval(() => {
            scheduleNote(playSet[idx], ctx.currentTime);
            idx = (idx + 1) % playSet.length;
        }, stepTime);
        
    } else if (perfMode === 'PATTERN') {
        // Hardcoded Rhythmic Pattern (Root - Chord - Root - Chord)
        const msPerBeat = 60000 / currentBPM;
        const stepTime = msPerBeat * 0.5; // 8th notes
        
        let idx = 0;
        // Pattern: [Bass, FullChord, Bass, FullChord]
        const bass = notes[0];
        const chord = notes.slice(1);
        
        activeTimer = setInterval(() => {
            const t = ctx.currentTime;
            if (idx % 2 === 0) {
                scheduleNote(bass, t, 1.2); // Loud bass
            } else {
                chord.forEach(n => scheduleNote(n, t, 0.8)); // Softer chord
            }
            idx++;
        }, stepTime);
        
    } else if (perfMode === 'HARP') {
        // Super fast 3 octave sweep
        const speed = 5 + (perfDial * 30); // Very fast
        let extNotes = [...notes, ...notes.map(n=>n+12), ...notes.map(n=>n+24)];
        extNotes.sort((a,b)=>a-b);
        extNotes.forEach((midi, i) => {
            scheduleNote(midi, now + (i * speed / 1000));
        });
    }

    // UI Updates
    document.getElementById('disp-chord').innerText = (NOTES[scaleNote%12] || "?") + quality;
}

function scheduleNote(midi, time, vel=1.0) {
    const freq = mtof(midi);
    // Calculate delay in ms for setTimeout
    const delay = (time - ctx.currentTime) * 1000;
    if(delay < 0) {
        worklet.port.postMessage({type:'noteOn', freq, vel});
    } else {
        setTimeout(() => worklet.port.postMessage({type:'noteOn', freq, vel}), delay);
    }
}

function killAll() {
    if(activeTimer) clearInterval(activeTimer);
    if(worklet) worklet.port.postMessage({type:'kill'});
}

/* --- UI HELPERS --- */
function setParam(k, v) { if(worklet) worklet.port.postMessage({type:'param', key:k, val:v}); }
function setCart(i) {
    setParam('shape', i);
    [0,1,2].forEach(x => document.getElementById('cart-'+x).classList.remove('active'));
    document.getElementById('cart-'+i).classList.add('active');
}
function changeOctave(d) {
    globalOctave = Math.max(-2, Math.min(2, globalOctave+d));
    document.getElementById('disp-oct').innerText = "OCT " + globalOctave;
}
function setPerfMode(m) {
    perfMode = m;
    document.getElementById('disp-mode').innerText = m;
    updateLabel();
}
function updatePerfDial(v) {
    perfDial = v/100;
    updateLabel();
}
function setBPM(v) {
    currentBPM = parseInt(v);
    document.getElementById('disp-bpm').innerText = currentBPM;
}
function updateLabel() {
    let txt = "Speed";
    if (['ARP','ARP2','PATTERN'].includes(perfMode)) {
        if(perfDial < 0.3) txt = "1/4 Notes";
        else if(perfDial < 0.6) txt = "1/8 Notes";
        else txt = "1/16 Notes";
    } else if (perfMode === 'SLOP') {
        txt = "Sloppiness";
    }
    document.getElementById('dial-label').innerText = txt;
}

/* --- JOYSTICK & VISUALS --- */
const jBase=document.getElementById('joy-base'), jStick=document.getElementById('joy-stick');
let isDrag=false;
const moveJoy=(x,y)=>{
    const r=jBase.getBoundingClientRect();
    let nx=(x-(r.left+r.width/2))/(r.width/2), ny=(y-(r.top+r.height/2))/(r.height/2);
    const d=Math.sqrt(nx*nx+ny*ny); if(d>1){nx/=d;ny/=d;}
    joy={x:nx,y:ny};
    jStick.style.transform=`translate(calc(-50% + ${nx*50}px), calc(-50% + ${ny*50}px))`;
};
jBase.addEventListener('mousedown',e=>{isDrag=true;moveJoy(e.clientX,e.clientY)});
window.addEventListener('mousemove',e=>{if(isDrag)moveJoy(e.clientX,e.clientY)});
window.addEventListener('mouseup',()=>{isDrag=false;joy={x:0,y:0};jStick.style.transform='translate(-50%,-50%)'});
jBase.addEventListener('touchstart',e=>{isDrag=true;moveJoy(e.touches[0].clientX,e.touches[0].clientY);e.preventDefault()});
window.addEventListener('touchmove',e=>{if(isDrag)moveJoy(e.touches[0].clientX,e.touches[0].clientY)});
window.addEventListener('touchend',()=>{isDrag=false;joy={x:0,y:0};jStick.style.transform='translate(-50%,-50%)'});

const cvs=document.getElementById('main-canvas'), cc=cvs.getContext('2d');
function drawScreen() {
    requestAnimationFrame(drawScreen);
    cc.fillStyle='#222'; cc.fillRect(0,0,600,150);
    cc.strokeStyle='#ff9e40'; cc.lineWidth=2; cc.beginPath();
    for(let x=0;x<600;x+=5) {
        const y=75+Math.sin(x*0.05+Date.now()*0.01)*20*Math.sin(x*0.01);
        if(x===0)cc.moveTo(x,y); else cc.lineTo(x,y);
    }
    cc.stroke();
}
document.getElementById('btn-init').addEventListener('click', init);
window.addEventListener('touchstart', ()=>{if(ctx&&ctx.state==='suspended')ctx.resume()});
</script>
</body>
</html>